"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const AWS = require("aws-sdk");
const chai_1 = require("chai");
require("mocha");
const sinon = require("sinon");
const awsS3Module_1 = require("../src/awsS3Module");
const azureDataLakeModule_1 = require("../src/azureDataLakeModule");
const redisModule_1 = require("../src/redisModule");
const s3ToAdlDataCopy_1 = require("../src/s3ToAdlDataCopy");
describe("aws s3 tests", () => {
    let s3ToAdl;
    let adlModule;
    let awsS3Module;
    let redisModule;
    const expectedElement1 = {
        ETag: "123456",
        Key: "file1",
    };
    const expectedElement2 = {
        ETag: "123457",
        Key: "file2",
    };
    beforeEach(function () {
        process.env["AWS_ACCESS_KEY_ID"] = "key";
        process.env["AWS_SECRET_ACCESS_KEY"] = "secretkey";
        process.env["AWS_REGION"] = "region";
        process.env["AWS_BUCKET_NAME"] = "bucket";
        process.env["AZURE_CLIENT_ID"] = "client";
        process.env["AZURE_DOMAIN"] = "domain";
        process.env["AZURE_SECRET"] = "secret";
        process.env["AZURE_ADL_ACCOUNT_NAME"] = "account";
        process.env["TEMP_FOLDER"] = "./tempFolder";
        process.env["USE_REDIS"] = "false";
        const bucketName = "bucket";
        const tempFolder = "tempFolder";
        awsS3Module = new awsS3Module_1.AwsS3Module(bucketName, tempFolder, new AWS.S3());
        adlModule = new azureDataLakeModule_1.AzureDataLakeModule("accountName", "folderName", null, "bucket");
    });
    it("When required environment variables are missing exception is thrown", () => {
        // given
        delete process.env["AZURE_ADL_ACCOUNT_NAME"];
        // act
        try {
            s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        }
        catch (ex) {
            // assert
            chai_1.expect(ex.message).to.equal("Environment Variable AZURE_ADL_ACCOUNT_NAME is not defined");
        }
    });
    it("When USE_REDIS is set to other variable then true/false exception is thrown", () => {
        // given
        process.env["USE_REDIS"] = "some value";
        // act
        try {
            s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        }
        catch (ex) {
            // assert
            chai_1.expect(ex.message).to.equal("Environment Variable USE_REDIS should contain boolean value");
        }
    });
    it("batchIterationOverS3Items doesn't uploads file when it's already exists", () => __awaiter(this, void 0, void 0, function* () {
        // given
        sinon.stub(awsS3Module, "listAllObjects").returns({
            Contents: [expectedElement1, expectedElement2],
        });
        const uploadToAdlStub = sinon.stub(adlModule, "shouldUploadToADL").returns(new Promise((resolve) => {
            resolve(false);
        }));
        const awsSpy = sinon.spy(awsS3Module, "downloadFileFromS3");
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        yield s3ToAdl.batchIterationOverS3Items(awsS3Module, adlModule, null);
        // assert
        chai_1.expect(awsSpy.callCount).to.equal(0);
        chai_1.expect(uploadToAdlStub.callCount).to.equal(2);
    }));
    it("batchIterationOverS3Items uploads the missing file in ADL", () => __awaiter(this, void 0, void 0, function* () {
        // given
        sinon.stub(awsS3Module, "listAllObjects").returns({
            Contents: [expectedElement1, expectedElement2],
        });
        let downloadStub = sinon.stub(awsS3Module, "downloadFileFromS3").returns(new Promise((resolve) => resolve()));
        sinon.stub(adlModule, "uploadFileToAzureDataLake").returns(new Promise((resolve) => resolve()));
        const uploadStub = sinon.stub(adlModule, "shouldUploadToADL");
        uploadStub.withArgs(expectedElement1).returns(new Promise((resolve) => {
            resolve(false);
        }));
        uploadStub.withArgs(expectedElement2).returns(new Promise((resolve) => {
            resolve(true);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        yield s3ToAdl.batchIterationOverS3Items(awsS3Module, adlModule, null);
        // assert
        chai_1.expect(downloadStub.callCount).to.equal(1);
        chai_1.expect(uploadStub.callCount).to.equal(2);
    }));
    it("batchIterationOverS3Items when error is thrown while uploading file iteration continues as expected", () => __awaiter(this, void 0, void 0, function* () {
        // given
        sinon.stub(awsS3Module, "listAllObjects").returns({
            Contents: [expectedElement1, expectedElement2],
        });
        let downloadStub = sinon.stub(awsS3Module, "downloadFileFromS3").returns(new Promise((resolve) => resolve()));
        let uploadStub = sinon.stub(adlModule, "uploadFileToAzureDataLake");
        uploadStub.withArgs(expectedElement1.Key).throws(new Error());
        uploadStub.withArgs(expectedElement2.Key).returns(new Promise((resolve) => resolve()));
        const shouldUploadStub = sinon.stub(adlModule, "shouldUploadToADL").returns(new Promise((resolve) => {
            resolve(true);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        yield s3ToAdl.batchIterationOverS3Items(awsS3Module, adlModule, null);
        // assert
        chai_1.expect(downloadStub.callCount).to.equal(2);
        chai_1.expect(shouldUploadStub.callCount).to.equal(2);
        // expect only one since the second thrown an error
        chai_1.expect(s3ToAdl.copyProperties.uploadedCount).to.equal(1);
    }));
    it("shouldUploadFile return false when using redis and file exist on ADL", () => __awaiter(this, void 0, void 0, function* () {
        // given
        process.env["USE_REDIS"] = "true";
        const redisObj = new redisModule_1.RedisObject();
        redisObj.ETag = expectedElement1.ETag;
        redisModule = new redisModule_1.RedisModule(null, "bucket");
        const shouldUploadStub = sinon.stub(redisModule, "isFileInRedis").returns(new Promise((resolve) => {
            resolve(redisObj);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        let shouldUpload = yield s3ToAdl.shouldUploadFile(redisModule, adlModule, expectedElement1);
        // assert
        chai_1.expect(shouldUploadStub.callCount).to.equal(1);
        // expect only one since the second thrown an error
        chai_1.expect(shouldUpload).to.equal(false);
    }));
    it("shouldUploadFile return true when using redis and file is missing from ADL", () => __awaiter(this, void 0, void 0, function* () {
        // given
        process.env["USE_REDIS"] = "true";
        const redisObj = new redisModule_1.RedisObject();
        redisObj.ETag = "6543321";
        redisModule = new redisModule_1.RedisModule(null, "bucket");
        const shouldUploadStub = sinon.stub(redisModule, "isFileInRedis").returns(new Promise((resolve) => {
            resolve(redisObj);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        let shouldUpload = yield s3ToAdl.shouldUploadFile(redisModule, adlModule, expectedElement1);
        // assert
        chai_1.expect(shouldUploadStub.callCount).to.equal(1);
        // expect only one since the second thrown an error
        chai_1.expect(shouldUpload).to.equal(true);
    }));
    it("shouldUploadFile return true and not update redis when redis is empty and file exist on ADL", () => __awaiter(this, void 0, void 0, function* () {
        // given
        process.env["USE_REDIS"] = "true";
        redisModule = new redisModule_1.RedisModule(null, "bucket");
        const isFileInRedisStub = sinon.stub(redisModule, "isFileInRedis").returns(new Promise((resolve) => {
            resolve(null);
        }));
        const addFileToRedisStub = sinon.stub(redisModule, "addFileToRedis").returns(new Promise((resolve) => {
            resolve();
        }));
        const uploadToAdlStub = sinon.stub(adlModule, "shouldUploadToADL").returns(new Promise((resolve) => {
            resolve(false);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        let shouldUpload = yield s3ToAdl.shouldUploadFile(redisModule, adlModule, expectedElement1);
        // assert
        chai_1.expect(isFileInRedisStub.callCount).to.equal(1);
        chai_1.expect(shouldUpload).to.equal(false);
        chai_1.expect(addFileToRedisStub.callCount).to.equal(1);
    }));
    it("shouldUploadFile return true and update redis when redis is empty and file exist on ADL", () => __awaiter(this, void 0, void 0, function* () {
        // given
        process.env["USE_REDIS"] = "true";
        redisModule = new redisModule_1.RedisModule(null, "bucket");
        const isFileInRedisStub = sinon.stub(redisModule, "isFileInRedis").returns(new Promise((resolve) => {
            resolve(null);
        }));
        const addFileToRedisStub = sinon.stub(redisModule, "addFileToRedis");
        const uploadToAdlStub = sinon.stub(adlModule, "shouldUploadToADL").returns(new Promise((resolve) => {
            resolve(true);
        }));
        // act
        s3ToAdl = new s3ToAdlDataCopy_1.S3ToAdlDataCopy();
        let shouldUpload = yield s3ToAdl.shouldUploadFile(redisModule, adlModule, expectedElement1);
        // assert
        chai_1.expect(isFileInRedisStub.callCount).to.equal(1);
        chai_1.expect(shouldUpload).to.equal(true);
        chai_1.expect(addFileToRedisStub.callCount).to.equal(0);
    }));
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3Rlc3QvczN0b2FkbERhdGFDb3B5VGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsK0JBQStCO0FBRS9CLCtCQUE4QjtBQUU5QixpQkFBZTtBQUdmLCtCQUErQjtBQUMvQixvREFBaUQ7QUFDakQsb0VBQWlFO0FBRWpFLG9EQUE4RDtBQUM5RCw0REFBeUQ7QUFFekQsUUFBUSxDQUFDLGNBQWMsRUFBRTtJQUVyQixJQUFJLE9BQXdCLENBQUM7SUFDN0IsSUFBSSxTQUE4QixDQUFDO0lBQ25DLElBQUksV0FBd0IsQ0FBQztJQUM3QixJQUFJLFdBQXdCLENBQUM7SUFFN0IsTUFBTSxnQkFBZ0IsR0FBRztRQUNyQixJQUFJLEVBQUUsUUFBUTtRQUNkLEdBQUcsRUFBRSxPQUFPO0tBQ2YsQ0FBQztJQUNGLE1BQU0sZ0JBQWdCLEdBQUc7UUFDckIsSUFBSSxFQUFFLFFBQVE7UUFDZCxHQUFHLEVBQUUsT0FBTztLQUNmLENBQUM7SUFFRixVQUFVLENBQUM7UUFDUCxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQ3pDLE9BQU8sQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsR0FBRyxXQUFXLENBQUM7UUFDbkQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsR0FBRyxRQUFRLENBQUM7UUFDckMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLFFBQVEsQ0FBQztRQUMxQyxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLEdBQUcsUUFBUSxDQUFDO1FBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEdBQUcsUUFBUSxDQUFDO1FBQ3ZDLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEdBQUcsUUFBUSxDQUFDO1FBQ3ZDLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLENBQUMsR0FBRyxTQUFTLENBQUM7UUFDbEQsT0FBTyxDQUFD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QUFDLENBQUMsQ0FBQyIsImZpbGUiOiJ0ZXN0L3MzdG9hZGxEYXRhQ29weVRlc3QuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBBV1MgZnJvbSBcImF3cy1zZGtcIjtcclxuaW1wb3J0ICogYXMgYWRsc01hbmFnZW1lbnQgZnJvbSBcImF6dXJlLWFybS1kYXRhbGFrZS1zdG9yZVwiO1xyXG5pbXBvcnQgeyBleHBlY3QgfSBmcm9tIFwiY2hhaVwiO1xyXG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnNcIjtcclxuaW1wb3J0IFwibW9jaGFcIjtcclxuaW1wb3J0ICogYXMgQVdTTW9jayBmcm9tIFwibW9jay1hd3MtczNcIjtcclxuaW1wb3J0ICogYXMgbXNyZXN0QXp1cmUgZnJvbSBcIm1zLXJlc3QtYXp1cmVcIjtcclxuaW1wb3J0ICogYXMgc2lub24gZnJvbSBcInNpbm9uXCI7XHJcbmltcG9ydCB7IEF3c1MzTW9kdWxlIH0gZnJvbSBcIi4uL3NyYy9hd3NTM01vZHVsZVwiO1xyXG5pbXBvcnQgeyBBenVyZURhdGFMYWtlTW9kdWxlIH0gZnJvbSBcIi4uL3NyYy9henVyZURhdGFMYWtlTW9kdWxlXCI7XHJcbmltcG9ydCB7IGNyZWF0ZURpcklmTm90RXhpc3RzLCBkZWxldGVGb2xkZXIgfSBmcm9tIFwiLi4vc3JjL2ZpbGVzSGVscGVyXCI7XHJcbmltcG9ydCB7IFJlZGlzTW9kdWxlLCBSZWRpc09iamVjdCB9IGZyb20gXCIuLi9zcmMvcmVkaXNNb2R1bGVcIjtcclxuaW1wb3J0IHsgUzNUb0FkbERhdGFDb3B5IH0gZnJvbSBcIi4uL3NyYy9zM1RvQWRsRGF0YUNvcHlcIjtcclxuXHJcbmRlc2NyaWJlKFwiYXdzIHMzIHRlc3RzXCIsICgpID0+IHtcclxuXHJcbiAgICBsZXQgczNUb0FkbDogUzNUb0FkbERhdGFDb3B5O1xyXG4gICAgbGV0IGFkbE1vZHVsZTogQXp1cmVEYXRhTGFrZU1vZHVsZTtcclxuICAgIGxldCBhd3NTM01vZHVsZTogQXdzUzNNb2R1bGU7XHJcbiAgICBsZXQgcmVkaXNNb2R1bGU6IFJlZGlzTW9kdWxlO1xyXG5cclxuICAgIGNvbnN0IGV4cGVjdGVkRWxlbWVudDEgPSB7XHJcbiAgICAgICAgRVRhZzogXCIxMjM0NTZcIixcclxuICAgICAgICBLZXk6IFwiZmlsZTFcIixcclxuICAgIH07XHJcbiAgICBjb25zdCBleHBlY3RlZEVsZW1lbnQyID0ge1xyXG4gICAgICAgIEVUYWc6IFwiMTIzNDU3XCIsXHJcbiAgICAgICAgS2V5OiBcImZpbGUyXCIsXHJcbiAgICB9O1xyXG5cclxuICAgIGJlZm9yZUVhY2goZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHByb2Nlc3MuZW52W1wiQVdTX0FDQ0VTU19LRVlfSURcIl0gPSBcImtleVwiO1xyXG4gICAgICAgIHByb2Nlc3MuZW52W1wiQVdTX1NFQ1JFVF9BQ0NFU1NfS0VZXCJdID0gXCJzZWNyZXRrZXlcIjtcclxuICAgICAgICBwcm9jZXNzLmVudltcIkFXU19SRUdJT05cIl0gPSBcInJlZ2lvblwiO1xyXG4gICAgICAgIHByb2Nlc3MuZW52W1wiQVdTX0JVQ0tFVF9OQU1FXCJdID0gXCJidWNrZXRcIjtcclxuICAgICAgICBwcm9jZXNzLmVudltcIkFaVVJFX0NMSUVOVF9JRFwiXSA9IFwiY2xpZW50XCI7XHJcbiAgICAgICAgcHJvY2Vzcy5lbnZbXCJBWlVSRV9ET01BSU5cIl0gPSBcImRvbWFpblwiO1xyXG4gICAgICAgIHByb2Nlc3MuZW52W1wiQVpVUkVfU0VDUkVUXCJdID0gXCJzZWNyZXRcIjtcclxuICAgICAgICBwcm9jZXNzLmVudltcIkFaVVJFX0FETF9BQ0NPVU5UX05BTUVcIl0gPSBcImFjY291bnRcIjtcclxuICAgICAgICBwcm9jZXNzLmVudltcIlRFTVBfRk9MREVSXCJdID0gXCIuL3RlbXBGb2xkZXJcIjtcclxuICAgICAgICBwcm9jZXNzLmVudltcIlVTRV9SRURJU1wiXSA9IFwiZmFsc2VcIjtcclxuXHJcbiAgICAgICAgY29uc3QgYnVja2V0TmFtZSA9IFwiYnVja2V0XCI7XHJcbiAgICAgICAgY29uc3QgdGVtcEZvbGRlciA9IFwidGVtcEZvbGRlclwiO1xyXG4gICAgICAgIGF3c1MzTW9kdWxlID0gbmV3IEF3c1MzTW9kdWxlKGJ1Y2tldE5hbWUsIHRlbXBGb2xkZXIsIG5ldyBBV1MuUzMoKSk7XHJcbiAgICAgICAgYWRsTW9kdWxlID0gbmV3IEF6dXJlRGF0YUxha2VNb2R1bGUoXCJhY2NvdW50TmFtZVwiLCBcImZvbGRlck5hbWVcIiwgbnVsbCwgXCJidWNrZXRcIik7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdChcIldoZW4gcmVxdWlyZWQgZW52aXJvbm1lbnQgdmFyaWFibGVzIGFyZSBtaXNzaW5nIGV4Y2VwdGlvbiBpcyB0aHJvd25cIiwgKCkgPT4ge1xyXG4gICAgICAgIC8vIGdpdmVuXHJcbiAgICAgICAgZGVsZXRlIHByb2Nlc3MuZW52W1wiQVpVUkVfQURMX0FDQ09VTlRfTkFNRVwiXTtcclxuXHJcbiAgICAgICAgLy8gYWN0XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgczNUb0FkbCA9IG5ldyBTM1RvQWRsRGF0YUNvcHkoKTtcclxuICAgICAgICB9IGNhdGNoIChleCkge1xyXG4gICAgICAgICAgICAvLyBhc3NlcnRcclxuICAgICAgICAgICAgZXhwZWN0KGV4Lm1lc3NhZ2UpLnRvLmVxdWFsKFwiRW52aXJvbm1lbnQgVmFyaWFibGUgQVpVUkVfQURMX0FDQ09VTlRfTkFNRSBpcyBub3QgZGVmaW5lZFwiKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdChcIldoZW4gVVNFX1JFRElTIGlzIHNldCB0byBvdGhlciB2YXJpYWJsZSB0aGVuIHRydWUvZmFsc2UgZXhjZXB0aW9uIGlzIHRocm93blwiLCAoKSA9PiB7XHJcbiAgICAgICAgLy8gZ2l2ZW5cclxuICAgICAgICBwcm9jZXNzLmVudltcIlVTRV9SRURJU1wiXSA9IFwic29tZSB2YWx1ZVwiO1xyXG5cclxuICAgICAgICAvLyBhY3RcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBzM1RvQWRsID0gbmV3IFMzVG9BZGxEYXRhQ29weSgpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGV4KSB7XHJcbiAgICAgICAgICAgIC8vIGFzc2VydFxyXG4gICAgICAgICAgICBleHBlY3QoZXgubWVzc2FnZSkudG8uZXF1YWwoXCJFbnZpcm9ubWVudCBWYXJpYWJsZSBVU0VfUkVESVMgc2hvdWxkIGNvbnRhaW4gYm9vbGVhbiB2YWx1ZVwiKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdChcImJhdGNoSXRlcmF0aW9uT3ZlclMzSXRlbXMgZG9lc24ndCB1cGxvYWRzIGZpbGUgd2hlbiBpdCdzIGFscmVhZHkgZXhpc3RzXCIsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAvLyBnaXZlblxyXG4gICAgICAgIHNpbm9uLnN0dWIoYXdzUzNNb2R1bGUsIFwibGlzdEFsbE9iamVjdHNcIikucmV0dXJucyh7XHJcbiAgICAgICAgICAgIENvbnRlbnRzOiBbZXhwZWN0ZWRFbGVtZW50MSwgZXhwZWN0ZWRFbGVtZW50Ml0sXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHVwbG9hZFRvQWRsU3R1YiA9IHNpbm9uLnN0dWIoYWRsTW9kdWxlLCBcInNob3VsZFVwbG9hZFRvQURMXCIpLnJldHVybnMobmV3IFByb21pc2U8Ym9vbGVhbj4oKHJlc29sdmUpID0+IHtcclxuICAgICAgICAgICAgcmVzb2x2ZShmYWxzZSk7XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICBjb25zdCBhd3NTcHkgPSBzaW5vbi5zcHkoYXdzUzNNb2R1bGUsIFwiZG93bmxvYWRGaWxlRnJvbVMzXCIpO1xyXG5cclxuICAgICAgICAvLyBhY3RcclxuICAgICAgICBzM1RvQWRsID0gbmV3IFMzVG9BZGxEYXRhQ29weSgpO1xyXG4gICAgICAgIGF3YWl0IHMzVG9BZGwuYmF0Y2hJdGVyYXRpb25PdmVyUzNJdGVtcyhhd3NTM01vZHVsZSwgYWRsTW9kdWxlLCBudWxsKTtcclxuXHJcbiAgICAgICAgLy8gYXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KGF3c1NweS5jYWxsQ291bnQpLnRvLmVxdWFsKDApO1xyXG4gICAgICAgIGV4cGVjdCh1cGxvYWRUb0FkbFN0dWIuY2FsbENvdW50KS50by5lcXVhbCgyKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KFwiYmF0Y2hJdGVyYXRpb25PdmVyUzNJdGVtcyB1cGxvYWRzIHRoZSBtaXNzaW5nIGZpbGUgaW4gQURMXCIsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAvLyBnaXZlblxyXG4gICAgICAgIHNpbm9uLnN0dWIoYXdzUzNNb2R1bGUsIFwibGlzdEFsbE9iamVjdHNcIikucmV0dXJucyh7XHJcbiAgICAgICAgICAgIENvbnRlbnRzOiBbZXhwZWN0ZWRFbGVtZW50MSwgZXhwZWN0ZWRFbGVtZW50Ml0sXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbGV0IGRvd25sb2FkU3R1YiA9IHNpbm9uLnN0dWIoYXdzUzNNb2R1bGUsIFwiZG93bmxvYWRGaWxlRnJvbVMzXCIpLnJldHVybnMobmV3IFByb21pc2UoKHJlc29sdmUpID0+IHJlc29sdmUoKSkpO1xyXG4gICAgICAgIHNpbm9uLnN0dWIoYWRsTW9kdWxlLCBcInVwbG9hZEZpbGVUb0F6dXJlRGF0YUxha2VcIikucmV0dXJucyhuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gcmVzb2x2ZSgpKSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHVwbG9hZFN0dWIgPSBzaW5vbi5zdHViKGFkbE1vZHVsZSwgXCJzaG91bGRVcGxvYWRUb0FETFwiKTtcclxuICAgICAgICB1cGxvYWRTdHViLndpdGhBcmdzKGV4cGVjdGVkRWxlbWVudDEpLnJldHVybnMobmV3IFByb21pc2U8Ym9vbGVhbj4oKHJlc29sdmUpID0+IHtcclxuICAgICAgICAgICAgcmVzb2x2ZShmYWxzZSk7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIHVwbG9hZFN0dWIud2l0aEFyZ3MoZXhwZWN0ZWRFbGVtZW50MikucmV0dXJucyhuZXcgUHJvbWlzZTxib29sZWFuPigocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKHRydWUpO1xyXG4gICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgLy8gYWN0XHJcbiAgICAgICAgczNUb0FkbCA9IG5ldyBTM1RvQWRsRGF0YUNvcHkoKTtcclxuICAgICAgICBhd2FpdCBzM1RvQWRsLmJhdGNoSXRlcmF0aW9uT3ZlclMzSXRlbXMoYXdzUzNNb2R1bGUsIGFkbE1vZHVsZSwgbnVsbCk7XHJcblxyXG4gICAgICAgIC8vIGFzc2VydFxyXG4gICAgICAgIGV4cGVjdChkb3dubG9hZFN0dWIuY2FsbENvdW50KS50by5lcXVhbCgxKTtcclxuICAgICAgICBleHBlY3QodXBsb2FkU3R1Yi5jYWxsQ291bnQpLnRvLmVxdWFsKDIpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoXCJiYXRjaEl0ZXJhdGlvbk92ZXJTM0l0ZW1zIHdoZW4gZXJyb3IgaXMgdGhyb3duIHdoaWxlIHVwbG9hZGluZyBmaWxlIGl0ZXJhdGlvbiBjb250aW51ZXMgYXMgZXhwZWN0ZWRcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIC8vIGdpdmVuXHJcbiAgICAgICAgc2lub24uc3R1Yihhd3NTM01vZHVsZSwgXCJsaXN0QWxsT2JqZWN0c1wiKS5yZXR1cm5zKHtcclxuICAgICAgICAgICAgQ29udGVudHM6IFtleHBlY3RlZEVsZW1lbnQxLCBleHBlY3RlZEVsZW1lbnQyXSxcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbGV0IGRvd25sb2FkU3R1YiA9IHNpbm9uLnN0dWIoYXdzUzNNb2R1bGUsIFwiZG93bmxvYWRGaWxlRnJvbVMzXCIpLnJldHVybnMobmV3IFByb21pc2UoKHJlc29sdmUpID0+IHJlc29sdmUoKSkpO1xyXG4gICAgICAgIGxldCB1cGxvYWRTdHViID0gc2lub24uc3R1YihhZGxNb2R1bGUsIFwidXBsb2FkRmlsZVRvQXp1cmVEYXRhTGFrZVwiKTtcclxuICAgICAgICB1cGxvYWRTdHViLndpdGhBcmdzKGV4cGVjdGVkRWxlbWVudDEuS2V5KS50aHJvd3MobmV3IEVycm9yKCkpO1xyXG4gICAgICAgIHVwbG9hZFN0dWIud2l0aEFyZ3MoZXhwZWN0ZWRFbGVtZW50Mi5LZXkpLnJldHVybnMobmV3IFByb21pc2UoKHJlc29sdmUpID0+IHJlc29sdmUoKSkpO1xyXG5cclxuICAgICAgICBjb25zdCBzaG91bGRVcGxvYWRTdHViID0gc2lub24uc3R1YihhZGxNb2R1bGUsIFwic2hvdWxkVXBsb2FkVG9BRExcIikucmV0dXJucyhuZXcgUHJvbWlzZTxib29sZWFuPigocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKHRydWUpO1xyXG4gICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgLy8gYWN0XHJcbiAgICAgICAgczNUb0FkbCA9IG5ldyBTM1RvQWRsRGF0YUNvcHkoKTtcclxuICAgICAgICBhd2FpdCBzM1RvQWRsLmJhdGNoSXRlcmF0aW9uT3ZlclMzSXRlbXMoYXdzUzNNb2R1bGUsIGFkbE1vZHVsZSwgbnVsbCk7XHJcblxyXG4gICAgICAgIC8vIGFzc2VydFxyXG4gICAgICAgIGV4cGVjdChkb3dubG9hZFN0dWIuY2FsbENvdW50KS50by5lcXVhbCgyKTtcclxuICAgICAgICBleHBlY3Qoc2hvdWxkVXBsb2FkU3R1Yi5jYWxsQ291bnQpLnRvLmVxdWFsKDIpO1xyXG4gICAgICAgIC8vIGV4cGVjdCBvbmx5IG9uZSBzaW5jZSB0aGUgc2Vjb25kIHRocm93biBhbiBlcnJvclxyXG4gICAgICAgIGV4cGVjdChzM1RvQWRsLmNvcHlQcm9wZXJ0aWVzLnVwbG9hZGVkQ291bnQpLnRvLmVxdWFsKDEpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoXCJzaG91bGRVcGxvYWRGaWxlIHJldHVybiBmYWxzZSB3aGVuIHVzaW5nIHJlZGlzIGFuZCBmaWxlIGV4aXN0IG9uIEFETFwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgLy8gZ2l2ZW5cclxuICAgICAgICBwcm9jZXNzLmVudltcIlVTRV9SRURJU1wiXSA9IFwidHJ1ZVwiO1xyXG4gICAgICAgIGNvbnN0IHJlZGlzT2JqID0gbmV3IFJlZGlzT2JqZWN0KCk7XHJcbiAgICAgICAgcmVkaXNPYmouRVRhZyA9IGV4cGVjdGVkRWxlbWVudDEuRVRhZztcclxuICAgICAgICByZWRpc01vZHVsZSA9IG5ldyBSZWRpc01vZHVsZShudWxsLCBcImJ1Y2tldFwiKTtcclxuICAgICAgICBjb25zdCBzaG91bGRVcGxvYWRTdHViID0gc2lub24uc3R1YihyZWRpc01vZHVsZSwgXCJpc0ZpbGVJblJlZGlzXCIpLnJldHVybnMobmV3IFByb21pc2U8UmVkaXNPYmplY3Q+KChyZXNvbHZlKSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUocmVkaXNPYmopO1xyXG4gICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgLy8gYWN0XHJcbiAgICAgICAgczNUb0FkbCA9IG5ldyBTM1RvQWRsRGF0YUNvcHkoKTtcclxuICAgICAgICBsZXQgc2hvdWxkVXBsb2FkID0gYXdhaXQgczNUb0FkbC5zaG91bGRVcGxvYWRGaWxlKHJlZGlzTW9kdWxlLCBhZGxNb2R1bGUsIGV4cGVjdGVkRWxlbWVudDEpO1xyXG5cclxuICAgICAgICAvLyBhc3NlcnRcclxuICAgICAgICBleHBlY3Qoc2hvdWxkVXBsb2FkU3R1Yi5jYWxsQ291bnQpLnRvLmVxdWFsKDEpO1xyXG4gICAgICAgIC8vIGV4cGVjdCBvbmx5IG9uZSBzaW5jZSB0aGUgc2Vjb25kIHRocm93biBhbiBlcnJvclxyXG4gICAgICAgIGV4cGVjdChzaG91bGRVcGxvYWQpLnRvLmVxdWFsKGZhbHNlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KFwic2hvdWxkVXBsb2FkRmlsZSByZXR1cm4gdHJ1ZSB3aGVuIHVzaW5nIHJlZGlzIGFuZCBmaWxlIGlzIG1pc3NpbmcgZnJvbSBBRExcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIC8vIGdpdmVuXHJcbiAgICAgICAgcHJvY2Vzcy5lbnZbXCJVU0VfUkVESVNcIl0gPSBcInRydWVcIjtcclxuICAgICAgICBjb25zdCByZWRpc09iaiA9IG5ldyBSZWRpc09iamVjdCgpO1xyXG4gICAgICAgIHJlZGlzT2JqLkVUYWcgPSBcIjY1NDMzMjFcIjtcclxuICAgICAgICByZWRpc01vZHVsZSA9IG5ldyBSZWRpc01vZHVsZShudWxsLCBcImJ1Y2tldFwiKTtcclxuICAgICAgICBjb25zdCBzaG91bGRVcGxvYWRTdHViID0gc2lub24uc3R1YihyZWRpc01vZHVsZSwgXCJpc0ZpbGVJblJlZGlzXCIpLnJldHVybnMobmV3IFByb21pc2U8UmVkaXNPYmplY3Q+KChyZXNvbHZlKSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUocmVkaXNPYmopO1xyXG4gICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgLy8gYWN0XHJcbiAgICAgICAgczNUb0FkbCA9IG5ldyBTM1RvQWRsRGF0YUNvcHkoKTtcclxuICAgICAgICBsZXQgc2hvdWxkVXBsb2FkID0gYXdhaXQgczNUb0FkbC5zaG91bGRVcGxvYWRGaWxlKHJlZGlzTW9kdWxlLCBhZGxNb2R1bGUsIGV4cGVjdGVkRWxlbWVudDEpO1xyXG5cclxuICAgICAgICAvLyBhc3NlcnRcclxuICAgICAgICBleHBlY3Qoc2hvdWxkVXBsb2FkU3R1Yi5jYWxsQ291bnQpLnRvLmVxdWFsKDEpO1xyXG4gICAgICAgIC8vIGV4cGVjdCBvbmx5IG9uZSBzaW5jZSB0aGUgc2Vjb25kIHRocm93biBhbiBlcnJvclxyXG4gICAgICAgIGV4cGVjdChzaG91bGRVcGxvYWQpLnRvLmVxdWFsKHRydWUpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoXCJzaG91bGRVcGxvYWRGaWxlIHJldHVybiB0cnVlIGFuZCBub3QgdXBkYXRlIHJlZGlzIHdoZW4gcmVkaXMgaXMgZW1wdHkgYW5kIGZpbGUgZXhpc3Qgb24gQURMXCIsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAvLyBnaXZlblxyXG4gICAgICAgIHByb2Nlc3MuZW52W1wiVVNFX1JFRElTXCJdID0gXCJ0cnVlXCI7XHJcbiAgICAgICAgcmVkaXNNb2R1bGUgPSBuZXcgUmVkaXNNb2R1bGUobnVsbCwgXCJidWNrZXRcIik7XHJcbiAgICAgICAgY29uc3QgaXNGaWxlSW5SZWRpc1N0dWIgPSBzaW5vbi5zdHViKHJlZGlzTW9kdWxlLCBcImlzRmlsZUluUmVkaXNcIikucmV0dXJucyhuZXcgUHJvbWlzZTxSZWRpc09iamVjdD4oKHJlc29sdmUpID0+IHtcclxuICAgICAgICAgICAgcmVzb2x2ZShudWxsKTtcclxuICAgICAgICB9KSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGFkZEZpbGVUb1JlZGlzU3R1YiA9IHNpbm9uLnN0dWIocmVkaXNNb2R1bGUsIFwiYWRkRmlsZVRvUmVkaXNcIikucmV0dXJucyhuZXcgUHJvbWlzZTxSZWRpc09iamVjdD4oKHJlc29sdmUpID0+IHtcclxuICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgIH0pKTtcclxuICAgICAgICBjb25zdCB1cGxvYWRUb0FkbFN0dWIgPSBzaW5vbi5zdHViKGFkbE1vZHVsZSwgXCJzaG91bGRVcGxvYWRUb0FETFwiKS5yZXR1cm5zKG5ldyBQcm9taXNlPGJvb2xlYW4+KChyZXNvbHZlKSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUoZmFsc2UpO1xyXG4gICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgLy8gYWN0XHJcbiAgICAgICAgczNUb0FkbCA9IG5ldyBTM1RvQWRsRGF0YUNvcHkoKTtcclxuICAgICAgICBsZXQgc2hvdWxkVXBsb2FkID0gYXdhaXQgczNUb0FkbC5zaG91bGRVcGxvYWRGaWxlKHJlZGlzTW9kdWxlLCBhZGxNb2R1bGUsIGV4cGVjdGVkRWxlbWVudDEpO1xyXG5cclxuICAgICAgICAvLyBhc3NlcnRcclxuICAgICAgICBleHBlY3QoaXNGaWxlSW5SZWRpc1N0dWIuY2FsbENvdW50KS50by5lcXVhbCgxKTtcclxuICAgICAgICBleHBlY3Qoc2hvdWxkVXBsb2FkKS50by5lcXVhbChmYWxzZSk7XHJcbiAgICAgICAgZXhwZWN0KGFkZEZpbGVUb1JlZGlzU3R1Yi5jYWxsQ291bnQpLnRvLmVxdWFsKDEpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoXCJzaG91bGRVcGxvYWRGaWxlIHJldHVybiB0cnVlIGFuZCB1cGRhdGUgcmVkaXMgd2hlbiByZWRpcyBpcyBlbXB0eSBhbmQgZmlsZSBleGlzdCBvbiBBRExcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIC8vIGdpdmVuXHJcbiAgICAgICAgcHJvY2Vzcy5lbnZbXCJVU0VfUkVESVNcIl0gPSBcInRydWVcIjtcclxuICAgICAgICByZWRpc01vZHVsZSA9IG5ldyBSZWRpc01vZHVsZShudWxsLCBcImJ1Y2tldFwiKTtcclxuICAgICAgICBjb25zdCBpc0ZpbGVJblJlZGlzU3R1YiA9IHNpbm9uLnN0dWIocmVkaXNNb2R1bGUsIFwiaXNGaWxlSW5SZWRpc1wiKS5yZXR1cm5zKG5ldyBQcm9taXNlPFJlZGlzT2JqZWN0PigocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKG51bGwpO1xyXG4gICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgY29uc3QgYWRkRmlsZVRvUmVkaXNTdHViID0gc2lub24uc3R1YihyZWRpc01vZHVsZSwgXCJhZGRGaWxlVG9SZWRpc1wiKTtcclxuICAgICAgICBjb25zdCB1cGxvYWRUb0FkbFN0dWIgPSBzaW5vbi5zdHViKGFkbE1vZHVsZSwgXCJzaG91bGRVcGxvYWRUb0FETFwiKS5yZXR1cm5zKG5ldyBQcm9taXNlPGJvb2xlYW4+KChyZXNvbHZlKSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICAvLyBhY3RcclxuICAgICAgICBzM1RvQWRsID0gbmV3IFMzVG9BZGxEYXRhQ29weSgpO1xyXG4gICAgICAgIGxldCBzaG91bGRVcGxvYWQgPSBhd2FpdCBzM1RvQWRsLnNob3VsZFVwbG9hZEZpbGUocmVkaXNNb2R1bGUsIGFkbE1vZHVsZSwgZXhwZWN0ZWRFbGVtZW50MSk7XHJcblxyXG4gICAgICAgIC8vIGFzc2VydFxyXG4gICAgICAgIGV4cGVjdChpc0ZpbGVJblJlZGlzU3R1Yi5jYWxsQ291bnQpLnRvLmVxdWFsKDEpO1xyXG4gICAgICAgIGV4cGVjdChzaG91bGRVcGxvYWQpLnRvLmVxdWFsKHRydWUpO1xyXG4gICAgICAgIGV4cGVjdChhZGRGaWxlVG9SZWRpc1N0dWIuY2FsbENvdW50KS50by5lcXVhbCgwKTtcclxuICAgIH0pO1xyXG59KTsiXSwic291cmNlUm9vdCI6Ii4uIn0=
